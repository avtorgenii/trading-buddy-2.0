stages:
    - build
    - deploy

image: docker:latest
services:
    - docker:dind

variables:
    TAG: $CI_COMMIT_SHORT_SHA

default:
    before_script:
        - apk add --no-cache make
        - echo "$DOCKER_HUB_PASS" | docker login -u "$DOCKER_HUB_USER" --password-stdin
        - if [ -n "$CI_COMMIT_TAG" ]; then export TAG=$CI_COMMIT_TAG; fi

build_front_job:
    stage: build
    script:
        - make prep-front TAG=$TAG

build_back_job:
    stage: build
    script:
        - make prep-back TAG=$TAG


build_nginx_job:
    stage: build
    script:
        - make prep-nginx TAG=$TAG

build_backup_job:
    stage: build
    script:
        - make prep-backup TAG=$TAG


deploy_job:
    stage: deploy
    rules:
        - if: $CI_COMMIT_BRANCH == "main"
    before_script:
        - if [ -n "$CI_COMMIT_TAG" ]; then export TAG=$CI_COMMIT_TAG; fi

        - apk add --no-cache make openssh-client

        - eval $(ssh-agent -s)
        - echo "$SSH_PRIV_KEY" | ssh-add -

        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh

        - ssh-keyscan "$DROPLET_IP" >> ~/.ssh/known_hosts
    script:
        - ssh "root@$DROPLET_IP" "echo '$DOCKER_HUB_PASS' | docker login -u '$DOCKER_HUB_USER' --password-stdin"

        - cp "$DOT_ENV_FILE" .env.prod
        - cp "$BACKUP_ENV_FILE" backup.env

        - export DOCKER_HOST="ssh://root@$DROPLET_IP"
        - make compose-prod TAG=$TAG
        - docker system prune -a -f